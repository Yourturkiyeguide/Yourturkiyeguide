<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í—ñ–¥–≥—É–∫–∏ –∑ Firebase</title>
  <link rel="stylesheet" href="/assets/css/pages/reviews.css">
</head>
<body>
<!--–í—ñ–¥–≥—É–∫–∏-->
<div class="reviews-container">
  <div class="reviews-section">
    <h2 class="reviews-section-title">–í—ñ–¥–≥—É–∫–∏ –∫–ª—ñ—î–Ω—Ç—ñ–≤</h2>
    <p class="reviews-section-subtitle">–î—ñ–∑–Ω–∞–π—Ç–µ—Å—è, —â–æ –¥—É–º–∞—é—Ç—å –Ω–∞—à—ñ –∫–ª—ñ—î–Ω—Ç–∏ –ø—Ä–æ –Ω–∞—à—ñ –ø–æ—Å–ª—É–≥–∏</p>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—ñ–¥–≥—É–∫—ñ–≤ -->
    <div class="reviews-stats">
      <div class="reviews-stat-card">
        <div class="reviews-stat-number" id="totalReviews">0</div>
        <div class="reviews-stat-label">–í—Å—å–æ–≥–æ –≤—ñ–¥–≥—É–∫—ñ–≤</div>
      </div>
      <div class="reviews-stat-card">
        <div class="reviews-stat-number" id="averageRating">0.0</div>
        <div class="reviews-stat-label">–°–µ—Ä–µ–¥–Ω—ñ–π —Ä–µ–π—Ç–∏–Ω–≥</div>
      </div>
      <div class="reviews-stat-card">
        <div class="reviews-stat-number" id="fiveStarCount">0</div>
        <div class="reviews-stat-label">5-–∑—ñ—Ä–∫–æ–≤–∏—Ö –≤—ñ–¥–≥—É–∫—ñ–≤</div>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤—ñ–¥–≥—É–∫—É -->
    <form class="reviews-add-form" id="reviewForm">
      <h3 class="reviews-form-title">–ó–∞–ª–∏—à–∏—Ç–∏ –≤—ñ–¥–≥—É–∫</h3>

      <div class="reviews-form-group">
        <label class="reviews-form-label" for="reviewerName">–í–∞—à–µ —ñ–º'—è *</label>
        <input type="text" id="reviewerName" class="reviews-form-input" required maxlength="50">
      </div>

      <div class="reviews-form-group">
        <label class="reviews-form-label" for="reviewerEmail">Email (–Ω–µ –±—É–¥–µ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ)</label>
        <input type="email" id="reviewerEmail" class="reviews-form-input" maxlength="100">
      </div>

      <div class="reviews-form-group">
        <label class="reviews-form-label">–†–µ–π—Ç–∏–Ω–≥ *</label>
        <div class="reviews-rating-input" id="ratingInput">
          <span class="reviews-star" data-rating="1">‚òÖ</span>
          <span class="reviews-star" data-rating="2">‚òÖ</span>
          <span class="reviews-star" data-rating="3">‚òÖ</span>
          <span class="reviews-star" data-rating="4">‚òÖ</span>
          <span class="reviews-star" data-rating="5">‚òÖ</span>
        </div>
      </div>

      <div class="reviews-form-group">
        <label class="reviews-form-label" for="reviewText">–í–∞—à –≤—ñ–¥–≥—É–∫ *</label>
        <textarea id="reviewText" class="reviews-form-textarea" required maxlength="500" placeholder="–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º –¥–æ—Å–≤—ñ–¥–æ–º..."></textarea>
      </div>

      <button type="submit" class="reviews-submit-btn">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
    </form>

    <!-- –°–ø–∏—Å–æ–∫ –≤—ñ–¥–≥—É–∫—ñ–≤ -->
    <div class="reviews-grid" id="reviewsContainer">
      <div class="reviews-empty-state">
        <div class="reviews-empty-state-icon">üí¨</div>
        <h3>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤</h3>
        <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º, —Ö—Ç–æ –∑–∞–ª–∏—à–∏—Ç—å –≤—ñ–¥–≥—É–∫!</p>
      </div>
    </div>
  </div>
</div>

<!-- Firebase CDN -->
<script type="module">
  // Import Firebase
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, collection, addDoc, getDocs, orderBy, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyASoIqknT0hMi7QTsKS_nBJbDvC9aWbcW0",
    authDomain: "reviews-project-travels-turkey.firebaseapp.com",
    projectId: "reviews-project-travels-turkey",
    storageBucket: "reviews-project-travels-turkey.firebasestorage.app",
    messagingSenderId: "695056378421",
    appId: "1:695056378421:web:863f7533509fdf791bdf7c"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  class ReviewsSystem {
    constructor() {
      this.reviews = [];
      this.selectedRating = 0;
      this.db = db;
      this.init();
    }

    async init() {
      this.setupEventListeners();
      await this.loadReviews();
      this.renderReviews();
      this.updateStats();
    }

    setupEventListeners() {
      // –†–µ–π—Ç–∏–Ω–≥ –∑—ñ—Ä–æ—á–∫–∏
      const stars = document.querySelectorAll('.reviews-rating-input .reviews-star');
      stars.forEach(star => {
        star.addEventListener('click', (e) => {
          this.selectedRating = parseInt(e.target.dataset.rating);
          this.updateStarDisplay();
        });

        star.addEventListener('mouseenter', (e) => {
          const rating = parseInt(e.target.dataset.rating);
          this.highlightStars(rating);
        });
      });

      document.getElementById('ratingInput').addEventListener('mouseleave', () => {
        this.updateStarDisplay();
      });

      // –§–æ—Ä–º–∞
      document.getElementById('reviewForm').addEventListener('submit', (e) => {
        e.preventDefault();
        this.addReview();
      });
    }

    highlightStars(rating) {
      const stars = document.querySelectorAll('.reviews-rating-input .reviews-star');
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }

    updateStarDisplay() {
      this.highlightStars(this.selectedRating);
    }

    async addReview() {
      const name = document.getElementById('reviewerName').value.trim();
      const email = document.getElementById('reviewerEmail').value.trim();
      const text = document.getElementById('reviewText').value.trim();

      if (!name || !text || this.selectedRating === 0) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è —Ç–∞ –ø–æ—Å—Ç–∞–≤—Ç–µ —Ä–µ–π—Ç–∏–Ω–≥');
        return;
      }

      const review = {
        name: name,
        email: email,
        rating: this.selectedRating,
        text: text,
        date: new Date().toLocaleDateString('uk-UA'),
        timestamp: serverTimestamp()
      };

      try {
        // –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        const btn = document.querySelector('.reviews-submit-btn');
        const originalText = btn.textContent;
        btn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
        btn.disabled = true;

        // –î–æ–¥–∞—Ç–∏ –≤ Firebase
        await addDoc(collection(this.db, 'reviews'), review);

        // –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ
        await this.loadReviews();
        this.renderReviews();
        this.updateStats();
        this.resetForm();

        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—Ö
        btn.textContent = '–í—ñ–¥–≥—É–∫ –¥–æ–¥–∞–Ω–æ! ‚úì';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –¥–æ–¥–∞–≤–∞–Ω–Ω—ñ –≤—ñ–¥–≥—É–∫—É:', error);
        alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –≤—ñ–¥–≥—É–∫—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');

        const btn = document.querySelector('.reviews-submit-btn');
        btn.textContent = '–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –≤—ñ–¥–≥—É–∫';
        btn.disabled = false;
      }
    }

    resetForm() {
      document.getElementById('reviewForm').reset();
      this.selectedRating = 0;
      this.updateStarDisplay();
    }

    async loadReviews() {
      try {
        const q = query(collection(this.db, 'reviews'), orderBy('timestamp', 'desc'));
        const querySnapshot = await getDocs(q);

        this.reviews = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ timestamp –≤ –¥–∞—Ç—É —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
          if (data.timestamp && data.timestamp.toDate) {
            data.date = data.timestamp.toDate().toLocaleDateString('uk-UA');
          }
          this.reviews.push({
            id: doc.id,
            ...data
          });
        });
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –≤—ñ–¥–≥—É–∫—ñ–≤:', error);
        this.reviews = [];
      }
    }

    renderReviews() {
      const container = document.getElementById('reviewsContainer');

      if (this.reviews.length === 0) {
        container.innerHTML = `
                <div class="reviews-empty-state">
                  <div class="reviews-empty-state-icon">üí¨</div>
                  <h3>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –≤—ñ–¥–≥—É–∫—ñ–≤</h3>
                  <p>–ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º, —Ö—Ç–æ –∑–∞–ª–∏—à–∏—Ç—å –≤—ñ–¥–≥—É–∫!</p>
                </div>
              `;
        return;
      }

      container.innerHTML = this.reviews.map(review => `
              <div class="reviews-card">
                <div class="reviews-header">
                  <div class="reviews-reviewer-info">
                    <div class="reviews-reviewer-avatar">
                      ${review.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="reviews-reviewer-details">
                      <h4>${this.escapeHtml(review.name)}</h4>
                      <div class="reviews-date">${review.date}</div>
                    </div>
                  </div>
                  <div class="reviews-rating">
                    ${this.renderStars(review.rating)}
                  </div>
                </div>
                <div class="reviews-text">
                  ${this.escapeHtml(review.text)}
                </div>
              </div>
            `).join('');
    }

    renderStars(rating) {
      let stars = '';
      for (let i = 1; i <= 5; i++) {
        stars += `<span class="reviews-star ${i <= rating ? 'active' : ''}" style="cursor: default;">‚òÖ</span>`;
      }
      return stars;
    }

    updateStats() {
      const totalReviews = this.reviews.length;
      const averageRating = totalReviews > 0
        ? (this.reviews.reduce((sum, review) => sum + review.rating, 0) / totalReviews).toFixed(1)
        : '0.0';
      const fiveStarCount = this.reviews.filter(review => review.rating === 5).length;

      document.getElementById('totalReviews').textContent = totalReviews;
      document.getElementById('averageRating').textContent = averageRating;
      document.getElementById('fiveStarCount').textContent = fiveStarCount;
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  }

  // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–∏—Å—Ç–µ–º–∏ –≤—ñ–¥–≥—É–∫—ñ–≤
  document.addEventListener('DOMContentLoaded', () => {
    new ReviewsSystem();
  });
</script>
</body>
</html>
